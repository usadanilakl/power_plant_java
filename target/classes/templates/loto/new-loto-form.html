<!DOCTYPE html>
<html xmlns:th="<http://www.thymeleaf.org>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connection Test</title>
    <link rel="stylesheet" href="/bootstrap-5.3.3-dist/css/bootstrap.min.css">
    <meta name="_csrf" th:content="${_csrf.token}"/>
</head>
<body>

<div th:replace="~{partials/index::header}"></div>
<div class="container">
    <div class="row">
        <div class="col-md-12">

            <div th:if="${emptyBox == null}">
                <h1>NO EMPTY BOXES LEFT. ADD NEW BOX OR EMPTY ONE OF BOXES THAT ARE IN USE</h1>
            </div>

            <form th:object="${loto}" th:action="@{/lotos/create}" method="post" id="lotoForm">
<!--                <input class="form-control" type="text" th:field="*{id}"  th:value="${loto.id}">-->
                <div class="form-group">

                    <div th:if="${loto.createdBy != null}">
                        <label for="created-by">Created By</label>
                        <input type="text" id="created-by" th:field="*{createdBy}" th:value="${loto.createdBy}">
<!--                        <p th:text="${loto.createdBy}"></p>-->
                    </div>
                    <div th:if="${loto.createdBy == null}">
                        <label for="created-by2">Created By</label>
                        <input type="text" id="created-by2" th:field="*{createdBy}" th:value="${#authentication.principal.name}">
                        <p th:text="${#authentication.principal.name}"></p>
                    </div>
<!--                    <input type="text" id="created-by" th:field="*{approvedBy}" th:value="${loto.createdBy}">-->
<!--                    <input type="text" id="created-by" th:value="${#authentication.principal.name}">-->
                </div>
                <div class="form-group">
                    <label for="requestor">Requestor</label>
                    <input class="form-control" type="text" id="requestor" th:field="*{requestor}">
                </div>
<!--                <div class="form-group">-->
<!--                    <label for="time">Time</label>-->
<!--                    <input class="form-control" type="datetime-local" id="time" th:value="${loto.dateCreated}">-->
<!--                </div>-->
                <div class="form-group">
                    <label for="workscope">Scope of Work</label>
                    <input class="form-control" type="text" id="workscope" th:field="*{workScope}">
                </div>
                <div class="form-group">
                    <label for="system">System</label>
                    <input class="form-control" type="text" id="system" th:field="*{system}">
                </div>
                <div class="form-group">
                    <label for="equipment">Equipment</label>
                    <input class="form-control" type="text" id="equipment" th:field="*{equipment}">
                </div>
                <div class="form-group">
                    <label for="boxDropdown">Box</label>
                    <select th:field="*{box}" id="boxDropdown" onchange="selectFunction()">
                        <option value="" >Select Box</option>
                        <option
                                th:each="b:${boxes}"
                                th:text="${b.number}"
                                th:value="${b.id}"
                        ></option>
                        <option value="-1">Add New Box</option>
                    </select>
                </div>
                <button class="btn btn-primary btn-block" type="submit">Submit</button>
            </form>
        </div>
    </div>
</div>

<script src="/bootstrap-5.3.3-dist/js/bootstrap.min.js"></script>
<script>
    let csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');

    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', function(e) {
            e.preventDefault();

            var formData = new FormData(document.getElementById('lotoForm'));
            fetch('/lotos/autosave', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => console.log(data))
                .catch((error) => {
                    console.error('Error:', error);
                });
        });
    });

   function createNewBoxPostRequest(){

    fetch("/lotos/add-box", {
        method: 'POST',
        headers: {
            'X-CSRF-TOKEN': csrfToken,
            'Content-Type': 'application/json'
        }
    })
        .then(()=>{
            window.location.href = "/lotos/create";
        })
        .catch((error) => {
            console.error('Error:', error);
        })

}

  function selectFunction() {
  var x = document.getElementById("boxDropdown").value;
  if(x === "-1") {
    createNewBoxPostRequest()
  }
}
</script>
</body>
</html>